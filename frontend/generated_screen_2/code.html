<!doctype html>

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Patitas Felices - Gestión Veterinaria</title>
    <!-- Load Bootstrap 5 for Grid and Components as requested -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
      rel="stylesheet"
    />
    <style data-purpose="theme-variables">
      :root {
        --primary-color: #13eca4; /* Custom color from THEME_3 */
        --secondary-color: #f8f9fa;
        --text-dark: #2d3436;
        --border-radius: 8px; /* ROUND_EIGHT from THEME_3 */
        --font-family: "Inter", sans-serif;
      }

      body {
        font-family: var(--font-family);
        background-color: #f4f7f6;
        color: var(--text-dark);
        margin: 0;
        padding-top: 70px; /* Space for fixed header */
      }
    </style>
    <style data-purpose="layout-and-styling">
      .navbar {
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-bottom: 2px solid var(--primary-color);
      }

      .navbar-brand {
        font-weight: 700;
        color: var(--text-dark) !important;
      }

      .section-container {
        background: #ffffff;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 3rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        border: 1px solid #edf2f7;
      }

      .section-title {
        color: var(--primary-color);
        font-weight: 700;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .table-title {
        color: #3498db; /* Blueish tone as per sketch colors */
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 2rem;
        margin-bottom: 1rem;
      }

      .form-control {
        border-radius: var(--border-radius);
        border: 1px solid #dcdde1;
        padding: 0.6rem;
      }

      .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(19, 236, 164, 0.25);
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: #000;
        font-weight: 600;
        border-radius: var(--border-radius);
      }

      .btn-primary:hover {
        background-color: #0fd994;
        border-color: #0fd994;
        color: #000;
      }

      .table-container {
        border: 1px solid #e1e8ed;
        border-radius: var(--border-radius);
        overflow: hidden;
      }

      .table thead {
        background-color: #f8f9fa;
      }

      .btn-action {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
        border-radius: 4px;
        margin-right: 4px;
      }

      .btn-edit {
        background-color: #f39c12;
        color: white;
        border: none;
      }
      .btn-delete {
        background-color: #e74c3c;
        color: white;
        border: none;
      }

      .text-primary {
        color: #ec5b13 !important;
      }

      /* Consistent input styling */
      .form-control,
      .form-select {
        height: 38px;
        font-size: 14px;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>
    <div
      id="notifications"
      class="position-fixed top-0 end-0 p-3"
      style="z-index: 1080"
    ></div>
    <!-- BEGIN: MainHeader -->
    <header>
      <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
          <a class="navbar-brand" href="#">
            <div
              class="bg-primary text-white p-2 rounded d-inline-flex align-items-center justify-content-center me-2"
            >
              <span class="material-symbols-outlined">pets</span>
            </div>
            Patitas<span class="text-primary">Felices</span>
          </a>
          <button
            class="navbar-toggler"
            data-bs-target="#navbarNav"
            data-bs-toggle="collapse"
            type="button"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="#dueños">Dueños</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#mascotas">Mascotas</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#historial">Historial</a>
              </li>
            </ul>
            <div class="d-flex ms-3">
              <button
                id="usuariosBtn"
                class="btn btn-outline-primary me-2 d-none"
              >
                Usuarios
              </button>
              <button id="logoutBtn" class="btn btn-outline-secondary">
                Cerrar Sesión
              </button>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <!-- END: MainHeader -->
    <!-- BEGIN: MainContent -->
    <main class="container my-5">
      <!-- BEGIN: SectionDueños -->
      <section
        class="section-container"
        data-purpose="owners-management"
        id="dueños"
      >
        <h2 class="section-title">Dueños</h2>
        <!-- Form Area -->
        <div class="row mb-4">
          <div class="col-12">
            <p class="text-muted mb-3">Cargar nuevos datos de propietarios</p>
            <form class="row g-3" id="duenos-form">
              <div class="col-md-3">
                <input
                  aria-label="Nombre"
                  class="form-control"
                  id="duenos-nombre"
                  placeholder="Nombre Completo"
                  type="text"
                  required
                />
              </div>
              <div class="col-md-3">
                <input
                  aria-label="Email"
                  class="form-control"
                  id="duenos-email"
                  placeholder="Correo Electrónico"
                  type="email"
                  required
                />
              </div>
              <div class="col-md-2">
                <input
                  aria-label="Teléfono"
                  class="form-control"
                  id="duenos-telefono"
                  placeholder="Teléfono"
                  type="tel"
                  required
                />
              </div>
              <div class="col-md-3">
                <input
                  aria-label="Dirección"
                  class="form-control"
                  id="duenos-direccion"
                  placeholder="Dirección"
                  type="text"
                />
              </div>
              <div class="col-md-1 d-grid">
                <button class="btn btn-primary" type="submit">Crear</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Table Area -->
        <h3 class="table-title">Tabla para ver la info de Dueños</h3>
        <div class="table-container">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Teléfono</th>
                <th>Dirección</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody id="duenos-tbody"></tbody>
          </table>
        </div>
      </section>
      <!-- END: SectionDueños -->
      <!-- BEGIN: SectionMascotas -->
      <section
        class="section-container"
        data-purpose="pets-management"
        id="mascotas"
      >
        <h2 class="section-title" style="color: #e67e22">Mascotas</h2>
        <!-- Orange accent from sketch -->
        <!-- Form Area -->
        <div class="row mb-4">
          <div class="col-12">
            <p class="text-muted mb-3">Registrar nueva mascota</p>
            <form class="row g-3" id="mascotas-form">
              <div class="col-md-2">
                <input
                  aria-label="Nombre Mascota"
                  class="form-control"
                  id="mascotas-nombre"
                  placeholder="Nombre Mascota"
                  type="text"
                  required
                />
              </div>
              <div class="col-md-2">
                <select
                  aria-label="Especie"
                  class="form-select"
                  id="mascotas-especie"
                  required
                >
                  <option selected="" disabled>Especie</option>
                  <option value="Perro">Perro</option>
                  <option value="Gato">Gato</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="col-md-2">
                <input
                  aria-label="Raza"
                  class="form-control"
                  id="mascotas-raza"
                  placeholder="Raza"
                  type="text"
                />
              </div>
              <div class="col-md-1">
                <input
                  aria-label="Edad"
                  class="form-control"
                  id="mascotas-edad"
                  placeholder="Edad"
                  type="number"
                  required
                />
              </div>
              <div class="col-md-3">
                <select
                  aria-label="Dueño"
                  class="form-select"
                  id="mascotas-dueno_id"
                  required
                >
                  <option selected disabled>Seleccionar Dueño</option>
                </select>
              </div>
              <div class="col-md-2 d-grid">
                <button class="btn btn-primary" type="submit">Crear</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Table Area -->
        <h3 class="table-title">Tabla para ver la info de Mascotas</h3>
        <div class="table-container">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Especie</th>
                <th>Raza</th>
                <th>Edad</th>
                <th>Dueño</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody id="mascotas-tbody"></tbody>
          </table>
        </div>
      </section>
      <!-- END: SectionMascotas -->
      <!-- BEGIN: SectionHistorial -->
      <section
        class="section-container"
        data-purpose="clinical-history-management"
        id="historial"
      >
        <h2 class="section-title" style="color: #e74c3c">Historial Clínico</h2>
        <!-- Red accent from sketch -->
        <!-- Form Area -->
        <div class="row mb-4">
          <div class="col-12">
            <p class="text-muted mb-3">Cargar nueva entrada clínica</p>
            <form class="row g-3" id="historial-form">
              <div class="col-md-2">
                <input
                  aria-label="Fecha"
                  class="form-control"
                  id="historial-fecha_consulta"
                  type="date"
                  required
                />
              </div>
              <div class="col-md-3">
                <select
                  aria-label="Mascota"
                  class="form-select"
                  id="historial-mascota_id"
                  required
                >
                  <option selected="" disabled>Seleccionar Mascota</option>
                </select>
              </div>
              <div class="col-md-3">
                <input
                  aria-label="Descripción"
                  class="form-control"
                  id="historial-descripcion"
                  placeholder="Descripción"
                  type="text"
                  required
                />
              </div>
              <div class="col-md-3">
                <input
                  aria-label="Tratamiento"
                  class="form-control"
                  id="historial-tratamiento"
                  placeholder="Tratamiento"
                  type="text"
                  required
                />
              </div>
              <div class="col-md-1 d-grid">
                <button class="btn btn-primary" type="submit">Crear</button>
              </div>
            </form>
          </div>
        </div>
        <!-- Table Area -->
        <h3 class="table-title">
          Tabla para ver la info de Historiales Clínicos
        </h3>
        <div class="table-container">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Mascota</th>
                <th>Descripción</th>
                <th>Tratamiento</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody id="historial-tbody"></tbody>
          </table>
        </div>
      </section>
      <!-- END: SectionHistorial -->
    </main>
    <!-- END: MainContent -->
    <!-- BEGIN: Footer -->
    <footer class="text-center py-4 text-muted">
      <div class="container border-top pt-3">
        <p>© 2023 Patitas Felices - Software de Gestión Veterinaria</p>
      </div>
    </footer>
    <!-- END: Footer -->
    <!-- Modals for Edit -->
    <!-- Edit Duenos Modal -->
    <div class="modal fade" id="editDuenosModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Dueño</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-duenos-form">
              <div class="mb-3">
                <label for="edit-duenos-nombre" class="form-label"
                  >Nombre</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-duenos-nombre"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-duenos-email" class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="edit-duenos-email"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-duenos-telefono" class="form-label"
                  >Teléfono</label
                >
                <input
                  type="tel"
                  class="form-control"
                  id="edit-duenos-telefono"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-duenos-direccion" class="form-label"
                  >Dirección</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-duenos-direccion"
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="edit-duenos-form"
              class="btn btn-primary"
            >
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Mascotas Modal -->
    <div class="modal fade" id="editMascotasModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Mascota</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-mascotas-form">
              <div class="mb-3">
                <label for="edit-mascotas-nombre" class="form-label"
                  >Nombre</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-mascotas-nombre"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-mascotas-especie" class="form-label"
                  >Especie</label
                >
                <select class="form-select" id="edit-mascotas-especie" required>
                  <option value="Perro">Perro</option>
                  <option value="Gato">Gato</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="edit-mascotas-raza" class="form-label">Raza</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-mascotas-raza"
                />
              </div>
              <div class="mb-3">
                <label for="edit-mascotas-edad" class="form-label">Edad</label>
                <input
                  type="number"
                  class="form-control"
                  id="edit-mascotas-edad"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-mascotas-dueno_id" class="form-label"
                  >Dueño</label
                >
                <select
                  class="form-select"
                  id="edit-mascotas-dueno_id"
                  required
                ></select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="edit-mascotas-form"
              class="btn btn-primary"
            >
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Historial Modal -->
    <div class="modal fade" id="editHistorialModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Historial</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-historial-form">
              <div class="mb-3">
                <label for="edit-historial-fecha_consulta" class="form-label"
                  >Fecha Consulta</label
                >
                <input
                  type="date"
                  class="form-control"
                  id="edit-historial-fecha_consulta"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-historial-mascota_id" class="form-label"
                  >Mascota</label
                >
                <select
                  class="form-select"
                  id="edit-historial-mascota_id"
                  required
                ></select>
              </div>
              <div class="mb-3">
                <label for="edit-historial-descripcion" class="form-label"
                  >Descripción</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-historial-descripcion"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-historial-tratamiento" class="form-label"
                  >Tratamiento</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-historial-tratamiento"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              form="edit-historial-form"
              class="btn btn-primary"
            >
              Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar eliminación</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">¿Estás seguro de eliminar este registro?</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const token = localStorage.getItem("token");
      let pendingDelete = null;

      function showNotice(message, type = "danger") {
        const container = document.getElementById("notifications");
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} alert-dismissible fade show shadow-sm`;
        notification.role = "alert";
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        container.appendChild(notification);
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 3000);
      }

      async function apiRequest(method, endpoint, data = null) {
        const options = {
          method,
          headers: { Authorization: "Bearer " + token },
        };
        if (data) {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(data);
        }
        return fetch(endpoint, options);
      }

      async function submitForm(endpoint, data, successMsg, formId) {
        try {
          const response = await apiRequest("POST", endpoint, data);
          if (response.ok) {
            loadData();
            document.getElementById(formId).reset();
            showNotice(successMsg, "success");
          } else {
            showNotice("Error al guardar");
          }
        } catch (error) {
          showNotice("Error de conexión");
        }
      }

      async function submitEditForm(endpoint, data, successMsg, modalId) {
        try {
          const response = await apiRequest("PATCH", endpoint, data);
          if (response.ok) {
            loadData();
            bootstrap.Modal.getInstance(
              document.getElementById(modalId),
            ).hide();
            showNotice(successMsg, "success");
          } else {
            showNotice("Error al guardar");
          }
        } catch (error) {
          showNotice("Error de conexión");
        }
      }

      if (!token) {
        window.location.href = "../index.html";
      }

      fetch("/api/auth/me", {
        headers: { Authorization: "Bearer " + token },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.role === "admin") {
            document.getElementById("usuariosBtn").classList.remove("d-none");
          }
        })
        .catch(() => {
          localStorage.removeItem("token");
          window.location.href = "../index.html";
        });

      document.getElementById("usuariosBtn").addEventListener("click", () => {
        window.location.href = "../alta_de_empleado_-_admin/code.html";
      });

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "../index.html";
      });

      function populateSelect(
        selectId,
        items,
        defaultOption = null,
        valueKey = "id",
        labelKey = "nombre",
      ) {
        const select = document.getElementById(selectId);
        select.innerHTML = defaultOption
          ? `<option selected disabled>${defaultOption}</option>`
          : "";
        items.forEach((item) => {
          select.innerHTML += `<option value="${item[valueKey]}">${item[labelKey]}</option>`;
        });
      }

      function renderActions(id, type) {
        return `<td class="text-end">
          <button class="btn btn-action btn-edit" data-id="${id}" data-type="${type}">Editar</button>
          <button class="btn btn-action btn-delete" data-id="${id}" data-type="${type}">Eliminar</button>
        </td>`;
      }

      async function loadData() {
        try {
          const [duenosRes, mascotasRes, historialRes] = await Promise.all([
            apiRequest("GET", "/api/duenos"),
            apiRequest("GET", "/api/mascotas"),
            apiRequest("GET", "/api/historial"),
          ]);

          const duenos = await duenosRes.json();
          const mascotas = await mascotasRes.json();
          const historial = await historialRes.json();

          document.getElementById("duenos-tbody").innerHTML = duenos
            .map(
              (d) => `<tr>
            <td>${d.id}</td>
            <td>${d.nombre}</td>
            <td>${d.email}</td>
            <td>${d.telefono}</td>
            <td>${d.direccion || "N/A"}</td>
            ${renderActions(d.id, "duenos")}
          </tr>`,
            )
            .join("");

          document.getElementById("mascotas-tbody").innerHTML = mascotas
            .map(
              (m) => `<tr>
            <td>${m.id}</td>
            <td>${m.nombre}</td>
            <td>${m.especie}</td>
            <td>${m.raza || "N/A"}</td>
            <td>${m.edad}</td>
            <td>${duenos.find((d) => d.id === m.dueno_id)?.nombre || "N/A"}</td>
            ${renderActions(m.id, "mascotas")}
          </tr>`,
            )
            .join("");

          document.getElementById("historial-tbody").innerHTML = historial
            .map(
              (h) => `<tr>
            <td>${new Date(h.fecha_consulta).toLocaleDateString()}</td>
            <td>${h.mascota_nombre || "N/A"}</td>
            <td>${h.descripcion}</td>
            <td>${h.tratamiento}</td>
            ${renderActions(h.id, "historial")}
          </tr>`,
            )
            .join("");

          populateSelect(
            "historial-mascota_id",
            mascotas,
            "Seleccionar Mascota",
          );
          populateSelect("edit-historial-mascota_id", mascotas);
          populateSelect("mascotas-dueno_id", duenos, "Seleccionar Dueño");
          populateSelect("edit-mascotas-dueno_id", duenos);
        } catch (error) {
          showNotice("Error cargando datos");
        }
      }

      loadData();

      document
        .getElementById("duenos-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitForm(
            "/api/duenos",
            {
              nombre: document.getElementById("duenos-nombre").value,
              email: document.getElementById("duenos-email").value,
              telefono: document.getElementById("duenos-telefono").value,
              direccion: document.getElementById("duenos-direccion").value,
            },
            "Dueño creado correctamente",
            "duenos-form",
          );
        });

      document
        .getElementById("mascotas-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitForm(
            "/api/mascotas",
            {
              nombre: document.getElementById("mascotas-nombre").value,
              especie: document.getElementById("mascotas-especie").value,
              raza: document.getElementById("mascotas-raza").value,
              edad: document.getElementById("mascotas-edad").value,
              dueno_id: document.getElementById("mascotas-dueno_id").value,
            },
            "Mascota creada correctamente",
            "mascotas-form",
          );
        });

      document
        .getElementById("historial-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await submitForm(
            "/api/historial",
            {
              fecha_consulta: document.getElementById(
                "historial-fecha_consulta",
              ).value,
              mascota_id: document.getElementById("historial-mascota_id").value,
              descripcion: document.getElementById("historial-descripcion")
                .value,
              tratamiento: document.getElementById("historial-tratamiento")
                .value,
            },
            "Historial creado correctamente",
            "historial-form",
          );
        });

      document
        .getElementById("edit-duenos-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = e.target.dataset.id;
          await submitEditForm(
            `/api/duenos/${id}`,
            {
              nombre: document.getElementById("edit-duenos-nombre").value,
              email: document.getElementById("edit-duenos-email").value,
              telefono: document.getElementById("edit-duenos-telefono").value,
              direccion: document.getElementById("edit-duenos-direccion").value,
            },
            "Dueño actualizado correctamente",
            "editDuenosModal",
          );
        });

      document
        .getElementById("edit-mascotas-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = e.target.dataset.id;
          await submitEditForm(
            `/api/mascotas/${id}`,
            {
              nombre: document.getElementById("edit-mascotas-nombre").value,
              especie: document.getElementById("edit-mascotas-especie").value,
              raza: document.getElementById("edit-mascotas-raza").value,
              edad: document.getElementById("edit-mascotas-edad").value,
              dueno_id: document.getElementById("edit-mascotas-dueno_id").value,
            },
            "Mascota actualizada correctamente",
            "editMascotasModal",
          );
        });

      document
        .getElementById("edit-historial-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = e.target.dataset.id;
          await submitEditForm(
            `/api/historial/${id}`,
            {
              fecha_consulta: document.getElementById(
                "edit-historial-fecha_consulta",
              ).value,
              mascota_id: document.getElementById("edit-historial-mascota_id")
                .value,
              descripcion: document.getElementById("edit-historial-descripcion")
                .value,
              tratamiento: document.getElementById("edit-historial-tratamiento")
                .value,
            },
            "Historial actualizado correctamente",
            "editHistorialModal",
          );
        });

      async function handleEdit(id, type) {
        try {
          const response = await apiRequest("GET", `/api/${type}/${id}`);
          const data = await response.json();

          if (type === "duenos") {
            document.getElementById("edit-duenos-nombre").value = data.nombre;
            document.getElementById("edit-duenos-email").value = data.email;
            document.getElementById("edit-duenos-telefono").value =
              data.telefono;
            document.getElementById("edit-duenos-direccion").value =
              data.direccion;
            document.getElementById("edit-duenos-form").dataset.id = id;
            new bootstrap.Modal(
              document.getElementById("editDuenosModal"),
            ).show();
          } else if (type === "mascotas") {
            document.getElementById("edit-mascotas-nombre").value = data.nombre;
            document.getElementById("edit-mascotas-especie").value =
              data.especie;
            document.getElementById("edit-mascotas-raza").value = data.raza;
            document.getElementById("edit-mascotas-edad").value = data.edad;
            document.getElementById("edit-mascotas-dueno_id").value =
              data.dueno_id;
            document.getElementById("edit-mascotas-form").dataset.id = id;
            new bootstrap.Modal(
              document.getElementById("editMascotasModal"),
            ).show();
          } else if (type === "historial") {
            const now = new Date();
            const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")}`;
            document.getElementById("edit-historial-fecha_consulta").value =
              today;
            document.getElementById("edit-historial-mascota_id").value =
              data.mascota_id;
            document.getElementById("edit-historial-descripcion").value =
              data.descripcion;
            document.getElementById("edit-historial-tratamiento").value =
              data.tratamiento;
            document.getElementById("edit-historial-form").dataset.id = id;
            new bootstrap.Modal(
              document.getElementById("editHistorialModal"),
            ).show();
          }
        } catch (error) {
          showNotice("Error al cargar datos para editar");
        }
      }

      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("btn-edit")) {
          await handleEdit(e.target.dataset.id, e.target.dataset.type);
        } else if (e.target.classList.contains("btn-delete")) {
          pendingDelete = {
            id: e.target.dataset.id,
            type: e.target.dataset.type,
          };
          new bootstrap.Modal(
            document.getElementById("deleteConfirmModal"),
          ).show();
        }
      });

      document
        .getElementById("confirmDeleteBtn")
        .addEventListener("click", async () => {
          if (!pendingDelete) return;

          try {
            const response = await apiRequest(
              "DELETE",
              `/api/${pendingDelete.type}/${pendingDelete.id}`,
            );
            if (response.ok) {
              loadData();
              showNotice("Registro eliminado correctamente", "success");
            } else {
              showNotice("Error al eliminar");
            }
          } catch (error) {
            showNotice("Error de conexión");
          } finally {
            pendingDelete = null;
            bootstrap.Modal.getInstance(
              document.getElementById("deleteConfirmModal"),
            ).hide();
          }
        });
    </script>
  </body>
</html>
